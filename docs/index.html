<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.547">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Hanxi Chen, Tianyu Duan, Hanlin Zhao">

<title>Assessing the Influence of Pesticide Usage, Parasitic Factors, and Climate on Honey Bee Populations in the United States (2015-2019)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul class="collapse">
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#project-summary" id="toc-project-summary" class="nav-link" data-scroll-target="#project-summary">Project Summary</a></li>
  <li><a href="#explanation-of-datasets" id="toc-explanation-of-datasets" class="nav-link" data-scroll-target="#explanation-of-datasets">Explanation of Datasets</a></li>
  </ul></li>
  <li><a href="#methods" id="toc-methods" class="nav-link" data-scroll-target="#methods">Methods</a>
  <ul class="collapse">
  <li><a href="#data-cleaning" id="toc-data-cleaning" class="nav-link" data-scroll-target="#data-cleaning">Data Cleaning</a></li>
  <li><a href="#data-analysis" id="toc-data-analysis" class="nav-link" data-scroll-target="#data-analysis">Data Analysis</a></li>
  </ul></li>
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results">Results</a>
  <ul class="collapse">
  <li><a href="#results-from-data-visualizations" id="toc-results-from-data-visualizations" class="nav-link" data-scroll-target="#results-from-data-visualizations">Results from data visualizations</a></li>
  <li><a href="#results-from-regression-models" id="toc-results-from-regression-models" class="nav-link" data-scroll-target="#results-from-regression-models">Results from regression models</a></li>
  </ul></li>
  <li><a href="#discussion" id="toc-discussion" class="nav-link" data-scroll-target="#discussion">Discussion</a></li>
  <li><a href="#future-directions" id="toc-future-directions" class="nav-link" data-scroll-target="#future-directions">Future Directions</a></li>
  <li><a href="#data-concerns-and-relational-vs.-non-relational" id="toc-data-concerns-and-relational-vs.-non-relational" class="nav-link" data-scroll-target="#data-concerns-and-relational-vs.-non-relational">Data Concerns and Relational vs.&nbsp;Non-Relational</a>
  <ul class="collapse">
  <li><a href="#a.-concerns-about-long-term-data-storage" id="toc-a.-concerns-about-long-term-data-storage" class="nav-link" data-scroll-target="#a.-concerns-about-long-term-data-storage">A. Concerns about long-term data storage</a></li>
  <li><a href="#b.-preserving-data-provenance" id="toc-b.-preserving-data-provenance" class="nav-link" data-scroll-target="#b.-preserving-data-provenance">B. Preserving data provenance</a></li>
  <li><a href="#c.-advantages-of-using-a-database" id="toc-c.-advantages-of-using-a-database" class="nav-link" data-scroll-target="#c.-advantages-of-using-a-database">C. Advantages of using a database</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="..\index.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Assessing the Influence of Pesticide Usage, Parasitic Factors, and Climate on Honey Bee Populations in the United States (2015-2019)</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Hanxi Chen, Tianyu Duan, Hanlin Zhao </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="introduction" class="level1">
<h1>Introduction</h1>
<section id="project-summary" class="level2">
<h2 class="anchored" data-anchor-id="project-summary">Project Summary</h2>
<p>Flowering plants play vital roles in natural and agricultural ecosystems, providing food, fiber, and shelter for wildlife and humans (Calderone, 2012). Pollination, a crucial step in their reproductive process, is typically necessary for seed production and is primarily carried out by animals, particularly bees (Calderone, 2012). With approximately 17,000 described species worldwide, bees are the most common pollinators (Calderone, 2012). However, the decline in honey bee colonies and other pollinators raises concerns about the impact on ecosystems (Calderone, 2012). Therefore, understanding this relationship is crucial for promoting sustainable agricultural practices and preserving biodiversity. Our project delves into the intricate associations between fluctuating levels of pesticide usage, diverse climate conditions, and the overall health (reflected by percentage loss) of honey bee populations in the USA.</p>
<p>Through rigorous investigation, we aim to uncover the complex interplay between these factors, shedding light on their combined effects on honey bee colonies across the United States. Our ultimate goal is to gain insights to enhance sustainable agricultural practices and preserve biodiversity.</p>
<p>In the planned data analysis, the primary focus is on investigating the interrelationships among pesticide usage, honey bee health metrics, and climate variables in the dataset spanning from 2015 to 2019. The analysis will involve correlation studies to uncover potential associations between these factors, utilizing statistical models to quantify the strength and direction of relationships after checking necessary assumptions. This approach is considered optimal for understanding the intricate connections between the variables and identifying patterns or trends that may influence honey bee colonies over time.</p>
<p>We will first create line graphs to visualize the overall trends in temperature change, pesticide usage, average air quality index (AQI) conditions, and the percentage loss of bees from 2015 to 2019 in the USA. Then, for the top 10 states that experienced the highest percentage loss of the bee population, we will plot these variables for each state to further examine if there are any specific trends on an individual state level and to identify potential associations on a smaller scale. Moreover, we will attempt to identify the variable that has the most significant association with the percentage loss of bee colonies. Initially, we will check for linearity and then assess multicollinearity using VIF scores. Finally, we will fit them into a linear regression model and use the R-squared value to evaluate the model. If the R-squared value is low, indicating a potential non-linear relationship, we will explore fitting a non-linear model to further examine the relationships.</p>
</section>
<section id="explanation-of-datasets" class="level2">
<h2 class="anchored" data-anchor-id="explanation-of-datasets">Explanation of Datasets</h2>
<p>In crafting our analytical framework, we have chosen four datasets to reveal the complex interplay between various factors influencing honey bee populations and agricultural ecosystems. Firstly, we draw upon the Pesticide Usage Data (https://www.kaggle.com/datasets/konradb/pesticide-usage-in-the-united-states/data), acquired from the National Water-Quality Assessment Project, offering insights into pesticide application trends across different states.</p>
<p>Complementing this, the Honey Bee Health Data (https://www.kaggle.com/datasets/m000sey/save-the-honey-bees/data), spanning from 2015 to 2022 and originally collected by the USDA, furnishes critical information on honey bee populations, facilitating a nuanced understanding of their health dynamics. Furthermore, NOAA’s Climate Data (https://www.kaggle.com/datasets/justinrwong/average-monthly-temperature-by-us-state), providing temperature insights by U.S. state, adds a crucial dimension to our analysis by elucidating the impact of climatic variations on honey bee behavior and pesticide usage patterns.</p>
<p>Lastly, the US Pollution Data (2000-2023) (https://www.kaggle.com/datasets/guslovesmath/us-pollution-data-200-to-2022), sourced from the U.S. Environmental Protection Agency, serves as a comprehensive resource for assessing air quality and pollution levels, aiding in delineating the environmental stressors influencing honey bee health. Each dataset was selected after careful consideration of factors such as reliability, relevance to our research objectives, and accessibility, aiming to provide a robust foundation for our investigation into sustainable agricultural practices and biodiversity conservation efforts.</p>
</section>
</section>
<section id="methods" class="level1">
<h1>Methods</h1>
<section id="data-cleaning" class="level2">
<h2 class="anchored" data-anchor-id="data-cleaning">Data Cleaning</h2>
<p>The main aim of the data-cleaning phase in the project is to maintain consistency and standardization across all observations. This involves arranging all metrics by year and state across the four datasets. The decision to adopt this approach arises from the inconsistencies present in the original datasets. For example, the Pesticide Usage Data was logged annually by state, focusing on individual compound usage, whereas the Honey Bee Health Data was recorded quarterly by state, providing various statistics on honey bee populations. Similar disparities were noted in other datasets. Additionally, discrepancies exist regarding the range of years and states covered. For instance, the Climate Data spans from 1950 to 2022, while the Honey Bee Health Data only covers 2015 to 2022. Moreover, although the U.S. Pollutant Data includes records for Alaska, it is absent in the other datasets. This inconsistency extends beyond Alaska to other states as well. Furthermore, the state column in the dataset was encoded with FIPS codes, which are not directly usable for analysis. Therefore, to improve data querying efficiency and enable more meaningful analyses, such cleaning procedures were deemed necessary. To tackle the FIPS code issue, the “us” package provides a “states.lookup” function for converting FIPS codes to state names directly. To handle record inconsistencies, the “.groupby” function from the pandas package was utilized for aggregated manipulation of each dataset. The application of “.groupby” involves grouping all datasets by year and state. In the case of the Pesticide Usage Data, grouping also includes “Compound” alongside year and state. Subsequently, additional metrics were calculated primarily using mean or sum after aggregation. However, for “percent_lost” and “percent_renovated” in the Honey Bee Health Data, a different calculation method was employed. Instead of mean or sum, these values were calculated by dividing the sum of renovated or lost colonies by the sum of total colonies and multiplying by one hundred. After testing, it was found that the common range of years spans from 2015 to 2019, covering all shared states. Therefore, observations falling outside this range were eliminated.</p>
<p>To ensure better alignment with the Data Definition Language (DDL), an additional cleaning step has been introduced. This involved removing any columns not specified in the Entity-Relationship (ER) diagram. For instance, in the processed U.S. Pollutant Data, columns such as those capturing maximum values or hours, which were not outlined in the ER diagram, were identified and subsequently removed during the cleaning phase. This action was taken to mitigate potential confusion during data entry into the database. Data restructuring has also been undertaken on the processed U.S. Pollutant Data. Previously, there were distinct columns for the average pollution and Air Quality Index (AQI) generated by each pollutant (e.g., O3 mean, O3 AQI). To better conform to the DDL, these columns have been reorganized into three columns. Each column now represents the pollutant’s name, the average pollution attributed to that pollutant, and the corresponding AQI value. It’s crucial to note that each observation in the modified U.S. Pollutant Data remains consistent, with each observation corresponding to a record within a specific year and state. Furthermore, a new dataset named RiskFactors has been created to facilitate the generation of the relationship table. This dataset comprises three columns: the state name, the year, and the compound name. These columns were extracted from the processed Pesticide Usage Data.</p>
<p>The cleaning phase of the project has been completed, resulting in a total of five datasets. These datasets encompass the processed NOAA’s Climate Data, containing 175 observations and 5 columns. These columns include year, state, average temperature, and the centroid longitude and latitude of each state. The processed Pesticide Usage Data comprises 875 observations and 5 columns. These columns consist of the compound name, year, and state, as well as low and high estimates of pesticide usage. The processed Honey Bee Health Data consists of 175 observations and 11 columns. These columns include state, year, number of colonies, maximum number of colonies, lost colonies, percentage of lost colonies, added colonies, amount of renovated colonies, percentage of renovated colonies, and various statistics related to potential factors affecting bee populations. Lastly, the US Pollution Data consists of 700 observations and 5 columns, representing the year, state, name of the pollutant, Air Quality Index (AQI), and the average amount of pollution generated by each pollutant.</p>
</section>
<section id="data-analysis" class="level2">
<h2 class="anchored" data-anchor-id="data-analysis">Data Analysis</h2>
<p>In our data analysis, after selecting the key explanatory variables to be temperature, concentrations of gas pollutants (CO, NO2, and SO2), percentage loss due to disease, and pesticide usage estimates, we first sought to explore the relationships between several key explanatory variables and our response variable, the percentage loss of bee colonies. This preliminary step was essential to assess whether the fundamental assumptions of linear regression—linearity, independence, homoscedasticity, and normality—were satisfied, thereby ensuring the statistical rigor of our findings.</p>
<div id="fig-linear_relationships" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-linear_relationships-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div id="fig-average_temperature" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-average_temperature-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/average_temperature_linearity.png" style="width:80.0%;height:80.0%" data-ref-parent="fig-linear_relationships" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-average_temperature-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) relationship between average temperature and percentage loss
</figcaption>
</figure>
</div>
<div id="fig-co_conc" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-co_conc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/co_conc_linearity.png" style="width:80.0%;height:80.0%" data-ref-parent="fig-linear_relationships" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-co_conc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) relationship between CO and percentage loss
</figcaption>
</figure>
</div>
<div id="fig-no2_conc" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-no2_conc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/no2_conc_linearity.png" style="width:80.0%;height:80.0%" data-ref-parent="fig-linear_relationships" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-no2_conc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c) relationship between NO2 and percentage loss
</figcaption>
</figure>
</div>
<div id="fig-percent_lost" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-percent_lost-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/percent_lost_by_disease_linearity.png" style="width:80.0%;height:80.0%" data-ref-parent="fig-linear_relationships" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-percent_lost-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(d) relationship between percentage loss by disease and percentage loss
</figcaption>
</figure>
</div>
<div id="fig-pesticide_estimate_linearity" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-pesticide_estimate_linearity-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/pesticide_estimate_linearity.png" style="width:80.0%;height:80.0%" data-ref-parent="fig-linear_relationships" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-pesticide_estimate_linearity-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(e) relationship between pesiticde estimate by disease and percentage loss
</figcaption>
</figure>
</div>
<div id="fig-so2_conc" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-so2_conc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/so2_conc_linearity.png" style="width:80.0%;height:80.0%" data-ref-parent="fig-linear_relationships" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-so2_conc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(f) relationship between SO2 and percentage loss
</figcaption>
</figure>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-linear_relationships-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: linear relationships
</figcaption>
</figure>
</div>
<p>We initiated this exploration by investigating the linearity between our key explanatory variables and the percentage loss of bee colonies. By generating scatter plots accompanied by best-fit lines for each variable against the percentage loss, we observed varying degrees of linearity. From <a href="#fig-linear_relationships" class="quarto-xref">Figure&nbsp;1</a>, notably, CO and NO2 concentrations demonstrated a clear positive trend, indicating a potential association of increased pollutants with higher bee colony losses. Conversely, SO2 concentrations exhibited a weaker and less defined relationship, suggesting a potentially lesser or non-linear impact on colony losses. Overall, the linearity assumption for linear regression is only partially met.</p>
<div class="cell" data-execution_count="2">
<div id="tbl-vif" class="cell quarto-float anchored" data-execution_count="2">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-vif-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: VIF summary
</figcaption>
<div aria-describedby="tbl-vif-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="5">
<div>


<table class="dataframe do-not-create-environment cell table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Variable</th>
<th data-quarto-table-cell-role="th">VIF</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>AverageTemperature</td>
<td>6.448131</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>CO_conc</td>
<td>1.080469</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>NO2_conc</td>
<td>5.968260</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>SO2_conc</td>
<td>2.182898</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>PercentLostByDisease</td>
<td>1.601289</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>PesticideEstimate</td>
<td>2.509423</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
<p>To address concerns of multicollinearity, which can inflate the variance of linear regression coefficients and compromise the interpretability of the model, we employed the Variance Inflation Factor (VIF). Our findings are illustrated in <a href="#tbl-vif" class="quarto-xref">Table&nbsp;1</a>, with all VIF scores remaining under the commonly accepted threshold of 10, indicated that multicollinearity was unlikely to be a significant issue in our dataset. This reassurance allowed us to proceed without the need to eliminate or merge variables to mitigate multicollinearity effects.</p>
<div id="fig-correlation_matrix" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-correlation_matrix-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/correlation_matrix.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-correlation_matrix-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Correlation between each pair of explanatory variables indicated by color intensity.
</figcaption>
</figure>
</div>
<p>Additionally, we scrutinized the correlations among our explanatory variables to determine the necessity of including interaction terms in our regression model. As shown in <a href="#fig-correlation_matrix" class="quarto-xref">Figure&nbsp;2</a>, the resulting correlation matrix revealed the absence of strong correlations between variables, as all the correlations are much smaller than 0.5, thereby negating the need for interaction terms. This was a crucial step in maintaining our model’s simplicity and ensuring its interpretability, adhering to the principle of Occam’s razor in statistical modeling.</p>
<p>Following our examination of linear relationships and correlations, we opted for linear regression as our initial analytical strategy. This choice was predicated on its simplicity, interpretability, and the preliminary indication of linear associations between several variables and the percentage loss of bee colonies. Linear regression allowed us to quantify the strength and direction of these relationships under the assumption that they hold a linear form, which is a common starting point in statistical analysis for its straightforwardness and efficiency in computation.</p>
<p>However, due to the absence of critical assumptions being fully met for linear regression, it suggested a limited capacity to capture the variability in bee colony losses. While carbon monoxide (CO) and nitrogen dioxide (NO2) concentrations emerged as significant predictors, the overall fit of the model highlighted the presence of potentially unaccounted complex relationships or additional influential factors not captured by our linear approach. In this case, investigation of non-linear relationships between explanatory variables with bee colony losses became crucial.</p>
<p>To explore the possibility of non-linear relationships influencing bee colony losses, we turned to XGBoost, a decision-tree-based ensemble machine learning algorithm known for its high performance and flexibility. XGBoost is particularly adept at handling non-linear data, making it an excellent candidate for our analysis. It can automatically learn complex patterns through its ensemble of decision trees and is capable of handling the interactions between features effectively, a potential limitation in linear models. Additionally, XGBoost includes regularization, which helps in preventing overfitting, a common concern when modeling complex relationships.</p>
<p>In summary, our exploration through linear and non-linear models underscores the challenges in modeling the factors affecting bee colony losses. The limited success of both approaches points towards the need for further investigation into other potential influencing factors, better quality data, or more sophisticated modeling techniques to capture the underlying dynamics more accurately. This journey through linear to non-linear modeling illustrates the iterative nature of data analysis, where initial findings often lead to new questions and subsequent analytical explorations.</p>
</section>
</section>
<section id="results" class="level1">
<h1>Results</h1>
<section id="results-from-data-visualizations" class="level2">
<h2 class="anchored" data-anchor-id="results-from-data-visualizations">Results from data visualizations</h2>
<div id="fig-year_lost" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-year_lost-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/year_lost.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-year_lost-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Average percentage loss of bees in the USA from 2015 to 2019.
</figcaption>
</figure>
</div>
<p>Based on <a href="#fig-year_lost" class="quarto-xref">Figure&nbsp;3</a>, we can observe that the average percentage loss of bee colonies differs over the 5-year period. The average percentage loss of bee colonies slightly increased from 2015 to 2016, then decreased from 15.5% to about 13.1% from 2016 to 2017. However, this percentage loss continued to increase for 2018 and 2019. The highest percentage loss occurred in 2016 (15.5%).</p>
<div id="fig-year_temp" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-year_temp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/year_temperature.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-year_temp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Average temperature in the USA from 2015 to 2019.
</figcaption>
</figure>
</div>
<p>Regarding average temperature <a href="#fig-year_temp" class="quarto-xref">Figure&nbsp;4</a>, it increased from 54.8°C to 56.1°C from 2015 to 2016, reaching the highest temperature among the 5 years, then decreased over the following three years. Since 2016 had both the highest average temperature and the highest average percentage loss for the USA, it may imply a potential association between temperature and bee health.</p>
<div id="fig-year_pest" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-year_pest-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/year_pesticide.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-year_pest-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Average pesticide usage in the USA from 2015 to 2019.
</figcaption>
</figure>
</div>
<p>In terms of pesticide usage in the USA <a href="#fig-year_pest" class="quarto-xref">Figure&nbsp;5</a>, the amount increased from 5300 kg in 2015 to its peak usage, approximately 5890 kg in 2016. Subsequently, the usage decreased over time until 2018, reaching about 5310 kg. The usage then increased to approximately 5750 kg in 2019. Since 2016 had both the highest pesticide usage and the highest average percentage loss of bees for the USA, it suggests a potential association between pesticide usage and bee health.</p>
<div id="fig-year_aqi" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-year_aqi-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/year_aqi.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-year_aqi-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Average AQI of gas conditions in the USA from 2015 to 2019.
</figcaption>
</figure>
</div>
<p>In terms of Average AQI <a href="#fig-year_aqi" class="quarto-xref">Figure&nbsp;6</a>, all four gases do not seem to change much between years in the USA. Since a higher AQI value indicates greater levels of air pollution and greater health concerns (Bishoi et al., 2009), O3 has the highest value of the Average AQI, posing the highest risk of contributing to bee health among these four gases, followed by NO2, CO, and SO2.</p>
</section>
<section id="results-from-regression-models" class="level2">
<h2 class="anchored" data-anchor-id="results-from-regression-models">Results from regression models</h2>
<div id="tbl-ols" class="cell quarto-float anchored" data-execution_count="3">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-ols-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: Results of linear regression.
</figcaption>
<div aria-describedby="tbl-ols-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-stdout">
<pre><code>                     Results: Ordinary least squares
=========================================================================
Model:                 OLS                Adj. R-squared:       0.110    
Dependent Variable:    PercentLost        AIC:                  1058.9125
Date:                  2024-06-05 03:18   BIC:                  1087.3956
No. Observations:      175                Log-Likelihood:       -520.46  
Df Model:              8                  F-statistic:          3.679    
Df Residuals:          166                Prob (F-statistic):   0.000561 
R-squared:             0.151              Scale:                23.641   
-------------------------------------------------------------------------
                      Coef.   Std.Err.    t    P&gt;|t|    [0.025    0.975] 
-------------------------------------------------------------------------
const                632.0818 547.6184  1.1542 0.2501 -449.1130 1713.2765
Year                  -0.3058   0.2712 -1.1274 0.2612   -0.8413    0.2297
AverageTemperature    -0.0553   0.0526 -1.0515 0.2946   -0.1591    0.0485
PercentLostByDisease  -0.0745   0.0748 -0.9962 0.3206   -0.2222    0.0732
CO_conc                8.9131   3.6597  2.4355 0.0159    1.6875   16.1387
NO2_conc               0.3263   0.1001  3.2612 0.0013    0.1288    0.5239
SO2_conc              -0.3515   0.8154 -0.4311 0.6670   -1.9614    1.2584
PesticideEstimate      0.0000   0.0001  0.0126 0.9899   -0.0002    0.0002
State_encoded         -0.0244   0.0420 -0.5812 0.5619   -0.1074    0.0586
-------------------------------------------------------------------------
Omnibus:                20.420         Durbin-Watson:            1.571   
Prob(Omnibus):          0.000          Jarque-Bera (JB):         29.597  
Skew:                   0.673          Prob(JB):                 0.000   
Kurtosis:               4.500          Condition No.:            11358072
=========================================================================
Notes:
[1] Standard Errors assume that the covariance matrix of the errors is
correctly specified.
[2] The condition number is large, 1.14e+07. This might indicate
that there are strong multicollinearity or other numerical
problems.</code></pre>
</div>
</div>
</figure>
</div>
<p>The linear regression results show that the model explains approximately 11% of the variability in the percent loss of bee colonies, as indicated by the adjusted R-squared value from <a href="#tbl-ols" class="quarto-xref">Table&nbsp;2</a>. Among the variables, carbon monoxide concentration (CO_conc) and nitrogen dioxide concentration (NO2_conc) are statistically significant at the 5% level, suggesting a potential association with the percent loss of bee colonies. The significance of these pollutants highlights them as factors that could influence bee colony losses. However, the low R-squared value suggests that the model does not fit the data very well, meaning that there are other unaccounted factors or complex relationships that influence the percent loss of bee colonies. The variables for year, average temperature, ozone concentration (O3_conc), sulfur dioxide concentration (SO2_conc), and state encoded as numeric values were not found to be significant predictors in this model.</p>
<p>Upon applying XGBoost to our data, we aimed to uncover non-linear patterns that linear regression may have missed. The model’s predictive performance, as measured by R-squared, was approximately 0.0667, indicating only a slight improvement in capturing the variability of bee colony losses compared to the linear model. This outcome suggested that while non-linear patterns might exist, they are either too intricate or too weakly associated with the data we have, or that other unaccounted factors play a more significant role than those we included in our model.</p>
<div id="fig-shap_train" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-shap_train-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/shap_train.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-shap_train-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Distribution of SHAP value for each predictors in the XGBoost model.
</figcaption>
</figure>
</div>
<div id="fig-shap_overall" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-shap_overall-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/shap_overall.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-shap_overall-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: Feature Importance Plot for the XGBoost model.
</figcaption>
</figure>
</div>
<p>The SHAP (SHapley Additive exPlanations) analysis provided further insights into the influence of individual features on the XGBoost model’s predictions, and the results are presented in <a href="#fig-shap_train" class="quarto-xref">Figure&nbsp;7</a>. The significant impact of features such as State and Year, as indicated by their SHAP values in <a href="#fig-shap_overall" class="quarto-xref">Figure&nbsp;8</a>, hinted at the complex interplay of temporal and geographical factors with bee colony health. However, given the overall low performance of the XGBoost model with an adjusted R-squared value of 0.0667, the XGBoost model has limited predictive power and explains only about 6.67% of the variance in the percent loss of bee colonies, and the findings must be interpreted with caution. They suggest that while certain variables show a stronger influence, the model’s capacity to accurately predict bee colony losses remains limited, underlining the complexity of the issue and the possibility of missing crucial explanatory variables or facing data quality issues.</p>
</section>
</section>
<section id="discussion" class="level1">
<h1>Discussion</h1>
<p>In examining our findings, several limitations emerge that warrant consideration. Firstly, the utilization of yearly temperature data, averaged across all months, may obscure the nuances of temperature fluctuations throughout the year, potentially hindering our ability to discern associations between temperature and other factors. Analyzing monthly temperature data would offer a more nuanced understanding of seasonal temperature variations, thus enriching our analysis. Additionally, variations in colony numbers by quarter, influenced by factors such as summer heat and natural bee biological cycles, may introduce complexities in interpreting colony trends. Moreover, the cyclical nature of parasite infestations, particularly in wintering states, underscores the importance of long-term monitoring to discern recurring patterns and inform proactive measures to safeguard bee health. Disparities in colony numbers between states further complicate analysis, influenced by factors like bee species diversity, habitat preferences, and unique environmental conditions. Methodologically, refining detection methods for colony numbers and pesticide usage is imperative, given the inherent biases introduced by larger states with more colonies and higher pesticide usage rates. Overall, the process of averaging to obtain yearly data results in a lack of specific changing patterns of these factors. Consequently, drawing conclusive conclusions based on the visualizations and regression models we built becomes challenging.</p>
</section>
<section id="future-directions" class="level1">
<h1>Future Directions</h1>
<p>Moving forward, several avenues for future research present themselves. A more granular analysis of factors such as temperature and pesticide usage using monthly data would yield insights into their fluctuations and impacts on bee colonies, aligning with previous research documenting seasonal colony loss rates (Kulhanek et al., 2017). Investigating seasonal variations in colony numbers across states can elucidate the interplay between environmental factors and bee biology, guiding targeted management strategies. Long-term monitoring of parasite trends in wintering states is essential to identify recurring patterns and develop proactive measures to mitigate their impact on bee health. Further exploration of state-specific factors contributing to disparities in colony numbers, such as bee species composition and habitat characteristics, promises to deepen our understanding of regional variations in beekeeping practices and pesticide usage. Methodological refinement, including the development of more sophisticated techniques to adjust for geographical differences in colony numbers and pesticide usage, will enhance the accuracy and reliability of data analysis, facilitating more robust conclusions and informed decision-making (Kulhanek et al., 2017).</p>
</section>
<section id="data-concerns-and-relational-vs.-non-relational" class="level1">
<h1>Data Concerns and Relational vs.&nbsp;Non-Relational</h1>
<p>When contemplating the long-term maintenance of our project data, several critical concerns emerge, particularly in the context of our investigation into the intricate relationships affecting honey bee populations and ecosystem sustainability.</p>
<section id="a.-concerns-about-long-term-data-storage" class="level2">
<h2 class="anchored" data-anchor-id="a.-concerns-about-long-term-data-storage">A. Concerns about long-term data storage</h2>
<p>As we delve into the analysis of factors impacting honey bee populations, one of our foremost concerns lies in ensuring the durability and accessibility of our data over time. Given the evolving landscape of data storage technologies, there is a risk of data formats becoming obsolete, potentially hindering our ability to retrieve or utilize historical data. Furthermore, the accumulation of vast amounts of data throughout the project’s duration presents challenges in terms of storage capacity and organization. It is imperative for us to implement robust data management strategies to adapt to evolving technologies and maintain the integrity and accessibility of our data for future research endeavors.</p>
</section>
<section id="b.-preserving-data-provenance" class="level2">
<h2 class="anchored" data-anchor-id="b.-preserving-data-provenance">B. Preserving data provenance</h2>
<p>The preservation of data provenance is another crucial aspect of our long-term data maintenance strategy. As we collect and analyze data from various sources, documenting the origin, processing steps, and any transformations applied to the data is essential for ensuring transparency, reproducibility, and accountability. By meticulously documenting data provenance throughout the project lifecycle, we can provide future researchers with the necessary context to validate and replicate our findings, thereby contributing to the integrity and reliability of scientific research in the field.</p>
</section>
<section id="c.-advantages-of-using-a-database" class="level2">
<h2 class="anchored" data-anchor-id="c.-advantages-of-using-a-database">C. Advantages of using a database</h2>
<p>Given the unique parameters of our project, there are instances where utilizing a database would offer distinct advantages over managing data through a series of individual files. Specifically, a database becomes advantageous when dealing with large volumes of interconnected data, such as the multitude of variables influencing honey bee populations and ecosystem dynamics. By leveraging a database, we can benefit from features such as structured data management, scalability, efficient query performance, and robust data integrity mechanisms. Additionally, databases provide a platform for implementing advanced analytical techniques and facilitating collaborative research efforts, making them particularly well-suited for projects with complex data requirements and analytical objectives.</p>
<p>When considering the advantages of using a database for our project, it’s essential to delve into the distinction between relational and non-relational databases, and how each may suit our specific needs.</p>
<p>Relational databases, characterized by their structured approach to data management using tables with predefined relationships between them, offer several advantages for our project. For example, we can organize our data into tables representing different aspects of honey bee populations, such as colony health, environmental factors, and pesticide usage. By establishing relationships between these tables, we can efficiently query and analyze interconnected data, enabling us to uncover complex patterns and relationships influencing honey bee populations.</p>
<p>One concrete example of when a relational database would be advantageous is in managing data on honey bee colony health and pesticide usage. We can create separate tables for colony health metrics and pesticide application data, linked by common identifiers such as geographic location or time period. This relational structure allows us to perform sophisticated analyses, such as identifying correlations between specific pesticides and changes in colony health over time.</p>
<p>On the other hand, non-relational databases, also known as NoSQL databases, offer flexibility and scalability for managing unstructured or semi-structured data. While relational databases excel in managing structured data with predefined schemas, non-relational databases are better suited for handling diverse data types, such as sensor data or social media feeds, without rigid schema requirements.</p>
<p>In our project, a non-relational database may be advantageous when dealing with unstructured or semi-structured data sources, such as climate sensor data or social media mentions of honey bee populations. For example, we could use a document-oriented database to store and analyze textual data from social media platforms, allowing us to identify public perceptions or concerns about honey bee health and correlate them with environmental factors.</p>
<p>In summary, the choice between using a relational or non-relational database depends on the nature of the data and the specific requirements of our project. Relational databases offer structured data management and predefined relationships, making them suitable for managing interconnected data on honey bee populations and ecosystem dynamics. Non-relational databases, on the other hand, provide flexibility and scalability for handling diverse data types, making them advantageous for managing unstructured or semi-structured data sources. In our case, since we are more interested in the relationships between different factors contributing to the loss of bees in the USA than in textual data from social media, etc., we believe a relational database will be more suitable. Additionally, the types of data we will be collecting are easy to handle in relational databases.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>